<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bond Terminal · Stream Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #07070a;
      --panel: #05070c;
      --panel-strong: #161c26;
      --panel-ghost: rgba(36, 39, 43, 0.82);
      --border: rgba(74, 82, 90, 0.55);
      --border-soft: rgba(62, 120, 178, 0.32);
      --accent: #004ba8;
      --accent-alt: #3e78b2;
      --accent-soft: rgba(62, 120, 178, 0.2);
      --accent-strong: rgba(0, 75, 168, 0.45);
      --success: #2dd4bf;
      --warn: #fbbf24;
      --error: #f87171;
      --text: #f3f6ff;
      --text-muted: #97a3ba;
      --mono: 'JetBrains Mono', monospace;
      --glow: rgba(0, 75, 168, 0.3);
      --gradient-radial: radial-gradient(135% 160% at 50% 0%, rgba(62, 120, 178, 0.24), rgba(7, 7, 10, 0.92));
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--gradient-radial), var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      height: 72px;
      background: linear-gradient(135deg, rgba(36, 39, 43, 0.95), rgba(7, 7, 10, 0.94));
      border-bottom: 1px solid rgba(62, 120, 178, 0.28);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 32px;
      padding: 0 36px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 14px 40px rgba(4, 6, 12, 0.6);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .brand span {
      font-size: 13px;
      color: rgba(247, 249, 255, 0.65);
    }

    .nav-link {
      appearance: none;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      padding: 8px 18px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.18s ease;
    }

    .nav-link:hover {
      color: var(--text);
      border-color: rgba(0, 75, 168, 0.4);
    }

    .nav-link.active {
      color: var(--text);
      background: var(--accent-soft);
      border-color: var(--accent-strong);
      box-shadow: 0 12px 24px rgba(0, 75, 168, 0.25);
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto;
    }

    .toolbar button,
    .toolbar a {
      border: 1px solid rgba(62, 120, 178, 0.28);
      background: rgba(36, 39, 43, 0.78);
      color: var(--text);
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    }

    .toolbar a {
      text-decoration: none;
    }

    .toolbar button.primary {
      background: linear-gradient(135deg, rgba(0, 75, 168, 0.85), rgba(62, 120, 178, 0.85));
      border-color: rgba(0, 75, 168, 0.45);
      box-shadow: 0 14px 38px rgba(0, 75, 168, 0.35);
    }

    .toolbar button:hover,
    .toolbar a:hover {
      transform: translateY(-1px);
      border-color: rgba(0, 75, 168, 0.45);
      background: rgba(36, 39, 43, 0.92);
    }

    .toolbar button.primary:hover {
      transform: translateY(-2px);
    }

    main {
      flex: 1;
      display: flex;
      gap: 28px;
      padding: 36px;
      min-height: 0;
    }

    .left-pane {
      width: 360px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(4, 6, 12, 0.55);
    }

    .session-list {
      padding: 22px 22px 18px;
      border-bottom: 1px solid rgba(62, 120, 178, 0.16);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-list h2 {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(247, 249, 255, 0.75);
    }

    #sessionNewBtn {
      border: 1px solid rgba(62,120,178,0.32);
      background: rgba(62,120,178,0.18);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    #sessionNewBtn:hover {
      background: rgba(62,120,178,0.26);
    }

    .sessions {
      flex: 0 0 auto;
      max-height: 220px;
      overflow-y: auto;
      padding: 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .session-item {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(62,120,178,0.18);
      background: rgba(36, 39, 43, 0.7);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }

    .session-item:hover,
    .session-item.active {
      transform: translateY(-2px);
      border-color: rgba(0,75,168,0.38);
      background: rgba(62,120,178,0.22);
    }

    .session-item span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .session-empty {
      padding: 32px 0;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-top: 1px solid rgba(62, 120, 178, 0.14);
      border-bottom: 1px solid rgba(62, 120, 178, 0.14);
      background: rgba(24, 29, 38, 0.7);
    }

    .chat-msg {
      display: flex;
      gap: 10px;
      font-size: 13px;
      animation: fadeIn 0.12s ease-out;
    }

    .chat-msg.agent {
      flex-direction: row;
    }

    .chat-msg.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: var(--accent-soft);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.08em;
      color: var(--accent);
    }

    .chat-msg.agent .avatar {
      background: rgba(0,75,168,0.45);
      color: #f2f7ff;
    }

    .bubble {
      max-width: 82%;
      background: rgba(24, 29, 38, 0.95);
      border: 1px solid rgba(62, 120, 178, 0.22);
      border-radius: 14px;
      padding: 12px 14px;
      line-height: 1.58;
      color: var(--text);
      box-shadow: 0 10px 28px rgba(4, 6, 12, 0.45);
    }

    .chat-msg.user .bubble {
      background: rgba(0,75,168,0.18);
      border-color: rgba(0,75,168,0.32);
      color: #e7f0ff;
    }

    .chat-input {
      padding: 18px 22px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: rgba(20, 25, 33, 0.88);
    }

    .chat-input textarea {
      min-height: 130px;
      resize: none;
      border-radius: 14px;
      background: rgba(14, 18, 26, 0.9);
      border: 1px solid rgba(62,120,178,0.24);
      color: var(--text);
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.6;
    }

    .chat-input textarea:focus {
      outline: none;
      border-color: rgba(0,75,168,0.5);
      box-shadow: 0 0 0 1px rgba(0,75,168,0.2);
      background: rgba(20, 26, 36, 0.95);
    }

    .chat-input button {
      align-self: flex-end;
      border-radius: 12px;
      border: 1px solid rgba(62,120,178,0.32);
      background: rgba(62,120,178,0.22);
      color: #e2ecff;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .chat-input button:hover {
      background: rgba(62,120,178,0.32);
    }

    .detail-pane {
      flex: 1;
      background: var(--panel-strong);
      border: 1px solid var(--border);
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(4, 6, 12, 0.55);
    }

    .detail-header {
      padding: 26px 30px;
      border-bottom: 1px solid rgba(62,120,178,0.18);
      background: rgba(24, 29, 38, 0.9);
      display: flex;
      justify-content: space-between;
      gap: 32px;
      align-items: flex-start;
    }

    .detail-header .summary {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .detail-header h2 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.015em;
    }

    .detail-header .summary div {
      display: flex;
      gap: 18px;
      font-size: 13px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .detail-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }

    .detail-controls .streams-actions button {
      padding: 6px 14px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 12px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid var(--accent-strong);
      background: var(--accent-soft);
      color: #f1f7ff;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-pill.warn {
      background: rgba(245, 158, 11, 0.18);
      border-color: rgba(245, 158, 11, 0.38);
      color: #fde68a;
    }

    .status-pill.error {
      background: rgba(248, 113, 113, 0.18);
      border-color: rgba(248, 113, 113, 0.38);
      color: #fecdd3;
    }

    .detail-body {
      padding: 28px 30px 32px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 22px;
      align-items: start;
      overflow-y: auto;
      max-height: calc(100vh - 72px - 110px);
      background: rgba(11, 14, 20, 0.88);
    }

    .panel {
      background: rgba(19, 23, 31, 0.95);
      border: 1px solid rgba(62,120,178,0.22);
      border-radius: 20px;
      padding: 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 18px 44px rgba(4, 6, 12, 0.45);
    }

    .panel h3 {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #d8e5f5;
    }

    .panel dl {
      display: grid;
      grid-template-columns: minmax(120px, 0.4fr) 1fr;
      row-gap: 12px;
      column-gap: 14px;
      font-size: 13px;
    }

    .panel dt {
      color: var(--text-muted);
      font-family: var(--mono);
      letter-spacing: 0.02em;
    }

    .panel dd {
      font-family: var(--mono);
      color: #e5e9ff;
    }

    .code-block {
      background: rgba(14, 18, 26, 0.95);
      border: 1px solid rgba(62,120,178,0.22);
      border-radius: 14px;
      padding: 14px 0 0;
      position: relative;
      overflow: hidden;
    }

    .code-block button {
      position: absolute;
      top: 12px;
      right: 12px;
      border: 1px solid rgba(62,120,178,0.35);
      background: rgba(62,120,178,0.18);
      color: #e0ecff;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .code-block pre {
      margin: 0;
      padding: 20px 20px 18px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.6;
      color: #d4e1f3;
    }

    .code-block .kw { color: #9ac7ff; }
    .code-block .const { color: #f9a8d4; }
    .code-block .str { color: #bef264; }
    .code-block .cmd { color: #facc15; }
    .code-block .flag { color: #fca5a5; }
    .code-block .comment { color: #8695ad; }

    .actions-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid rgba(62,120,178,0.28);
      background: rgba(24, 29, 38, 0.82);
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
    }

    .action-btn:hover {
      background: rgba(62,120,178,0.24);
      transform: translateY(-1px);
    }

    .action-btn.danger {
      border-color: rgba(248,113,113,0.45);
      background: rgba(127, 29, 29, 0.28);
      color: #fecaca;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px 22px;
      font-family: var(--mono);
      font-size: 13px;
    }

    .metrics-grid div span {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .sparkline-container {
      height: 54px;
      background: rgba(62,120,178,0.12);
      border: 1px solid rgba(62,120,178,0.22);
      border-radius: 14px;
      padding: 4px 6px;
    }

    .sparkline-container canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .column-merge {
      grid-column: 1 / -1;
    }

    .streams-view {
      display: none;
      flex-direction: column;
      flex: 1;
      gap: 24px;
      background: rgba(11, 14, 20, 0.78);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 24px 60px rgba(4, 6, 12, 0.5);
    }

    .streams-hero {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .streams-hero h2 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.015em;
    }

    .streams-hero-headline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .streams-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .streams-actions button {
      border: 1px solid rgba(62,120,178,0.32);
      background: rgba(62,120,178,0.16);
      color: #e0ecff;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .streams-actions button:hover {
      background: rgba(62,120,178,0.26);
    }

    .streams-hero p {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 560px;
    }

    .streams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
    }

    .stream-card {
      border: 1px solid rgba(62,120,178,0.24);
      background: rgba(24, 29, 38, 0.82);
      border-radius: 20px;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      cursor: pointer;
      transition: transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
      box-shadow: 0 18px 44px rgba(4, 6, 12, 0.45);
    }

    .stream-card:hover {
      transform: translateY(-4px);
      border-color: rgba(0,75,168,0.45);
      background: rgba(36, 42, 52, 0.92);
    }

    .stream-card.active {
      border-color: rgba(0,75,168,0.55);
      box-shadow: 0 20px 48px rgba(0,75,168,0.28);
    }

    .stream-card header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }

    .stream-card header h3 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .stream-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .stream-meta span {
      display: block;
    }

    .stream-card footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .stream-card footer button {
      border: 1px solid rgba(62,120,178,0.35);
      background: rgba(62,120,178,0.22);
      color: #e0ecff;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .stream-empty {
      padding: 40px 24px;
      border: 1px dashed rgba(62,120,178,0.3);
      border-radius: 18px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    body.view-chat main {
      justify-content: flex-start;
      align-items: stretch;
    }

    body.view-chat .left-pane {
      width: 100%;
      max-width: none;
      flex: 1;
      border-radius: 28px;
      border: 1px solid rgba(62,120,178,0.28);
    }

    body.view-chat .session-list,
    body.view-chat .sessions {
      display: none;
    }

    body.view-chat .chat-log {
      flex: 1;
      min-height: 420px;
      max-height: none;
      border-radius: 18px;
    }

    body.view-chat .chat-input {
      border-radius: 0 0 28px 28px;
    }

    body.view-chat .detail-pane {
      display: none;
    }

    body.view-chat #streamsView {
      display: none;
    }

    body.view-streams main {
      justify-content: center;
    }

    body.view-streams .left-pane,
    body.view-streams .detail-pane {
      display: none;
    }

    body.view-streams #streamsView {
      display: flex;
      max-width: 1100px;
    }

    body.view-stream-detail #streamsView {
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 1200px) {
      header {
        flex-wrap: wrap;
        height: auto;
        padding: 16px 24px;
        gap: 16px;
      }

      .toolbar {
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      main {
        flex-direction: column;
        padding: 24px;
      }

      .left-pane {
        width: 100%;
      }

      .detail-pane {
        width: 100%;
      }

      .detail-body {
        grid-template-columns: 1fr;
      }

      body.view-streams #streamsView {
        max-width: none;
      }
    }

    @media (max-width: 768px) {
      .toolbar {
        width: 100%;
        justify-content: center;
      }

      .toolbar button,
      .toolbar a {
        flex: 1;
        justify-content: center;
      }

      .streams-grid {
        grid-template-columns: 1fr;
      }

      .chat-log {
        max-height: none;
      }
    }
  </style>
</head>
<body class="view-chat">
  <header>
    <div class="brand">
      <h1>3KKO</h1>
    </div>
    <div class="toolbar">
      <button class="nav-link active" id="navChat">Chat</button>
      <button class="nav-link" id="navStreams">Streams</button>
      <a class="nav-link" href="https://docs.example.com" target="_blank" rel="noreferrer">Docs</a>
      <button class="nav-link" id="toolbarSettings">Settings</button>
      <button class="primary" id="toolbarNew">New Stream</button>
    </div>
  </header>

  <main>
    <aside class="left-pane">
      <div class="session-list">
        <h2>Streams</h2>
        <button id="sessionNewBtn">New</button>
      </div>
      <div class="sessions" id="sessionList"></div>
      <div class="chat-log" id="chatLog"></div>
      <form class="chat-input" id="chatForm">
        <textarea id="messageInput" placeholder="Ask Bond Agent to create or modify streams…" rows="4"></textarea>
        <button type="submit">Submit</button>
      </form>
    </aside>

    <section class="detail-pane" id="detailPane">
      <div class="detail-header" id="streamHeader">
        <div class="summary">
          <h2>Select a stream to view details</h2>
          <div style="display:flex;gap:18px;font-size:13px;color:var(--text-muted);">
            <span>No stream loaded</span>
          </div>
        </div>
        <div class="detail-controls">
          <div class="streams-actions detail-actions">
            <button data-action="pause-all">Pause All</button>
            <button data-action="export-all">Export Data</button>
          </div>
          <span class="status-pill" id="streamStatus" style="display:none;">• LIVE</span>
        </div>
      </div>
      <div class="detail-body" id="detailBody">
        <div class="panel column-merge" style="text-align:center;opacity:0.6;">
          <h3 style="margin-bottom:10px;">Awaiting Selection</h3>
          <p style="font-size:13px;color:var(--text-muted);">
            Use Bond Agent to launch a stream or select one from the Sessions list to inspect its metadata, schema, integrations, and performance metrics.
          </p>
        </div>
      </div>
    </section>
    <section class="streams-view" id="streamsView">
      <div class="streams-hero">
        <div class="streams-hero-headline">
          <h2>Active Streams</h2>
          <div class="streams-actions">
            <button data-action="pause-all">Pause All</button>
            <button data-action="export-all">Export Data</button>
          </div>
        </div>
        <p>Launch new streams from the chat, then jump back in here to inspect performance and metadata.</p>
      </div>
      <div class="streams-grid" id="streamsDirectory"></div>
    </section>
  </main>

  <script>
    const chatLog = document.getElementById('chatLog');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sessionList = document.getElementById('sessionList');
    const detailHeader = document.getElementById('streamHeader');
    const headerSummary = detailHeader.querySelector('.summary');
    const detailBody = document.getElementById('detailBody');
    const streamStatus = document.getElementById('streamStatus');
    const streamsView = document.getElementById('streamsView');
    const streamsDirectory = document.getElementById('streamsDirectory');
    const navChat = document.getElementById('navChat');
    const navStreams = document.getElementById('navStreams');
    const root = document.body;
    const VIEW_CHAT = 'chat';
    const VIEW_STREAMS = 'streams';
    const VIEW_DETAIL = 'stream-detail';
    const viewClasses = ['view-chat', 'view-streams', 'view-stream-detail'];

    const activeStreams = new Map();
    let currentStreamId = null;
    let pauseAll = false;

    function escapeHtml(str = '') {
      return str.replace(/[&<>"]+/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
    }

    function setView(nextView) {
      if (![VIEW_CHAT, VIEW_STREAMS, VIEW_DETAIL].includes(nextView)) {
        nextView = VIEW_CHAT;
      }
      currentView = nextView;
      root.classList.remove(...viewClasses);
      root.classList.add(`view-${nextView}`);
      if (navChat) {
        navChat.classList.toggle('active', nextView === VIEW_CHAT);
      }
      if (navStreams) {
        navStreams.classList.toggle('active', nextView === VIEW_STREAMS || nextView === VIEW_DETAIL);
      }
      if (nextView === VIEW_STREAMS && streamsView) {
        streamsView.scrollTop = 0;
      }
      if (nextView === VIEW_CHAT && messageInput) {
        messageInput.focus({ preventScroll: true });
      }
    }

    if (navChat) {
      navChat.addEventListener('click', (event) => {
        event.preventDefault();
        setView(VIEW_CHAT);
      });
    }

    if (navStreams) {
      navStreams.addEventListener('click', (event) => {
        event.preventDefault();
        setView(VIEW_STREAMS);
        renderStreamsDirectory();
      });
    }

    if (streamsDirectory) {
      streamsDirectory.addEventListener('click', (event) => {
        const target = event.target.closest('[data-stream]');
        if (!target) return;
        event.preventDefault();
        loadStream(target.dataset.stream);
      });
    }

    function appendMessage(role, html) {
      const wrapper = document.createElement('div');
      wrapper.className = 'chat-msg ' + role;
      wrapper.innerHTML = `
        <div class="avatar">${role === 'agent' ? 'AI' : 'ME'}</div>
        <div class="bubble">${html}</div>
      `;
      chatLog.appendChild(wrapper);
      chatLog.scrollTop = chatLog.scrollHeight;
      return wrapper.querySelector('.bubble');
    }

    const pauseAllButtons = Array.from(document.querySelectorAll('[data-action="pause-all"]'));
    const exportAllButtons = Array.from(document.querySelectorAll('[data-action="export-all"]'));

    function setPauseButtonLabels() {
      pauseAllButtons.forEach(btn => {
        btn.textContent = pauseAll ? 'Resume All' : 'Pause All';
      });
    }

    pauseAllButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        pauseAll = !pauseAll;
        appendMessage('agent', pauseAll ? 'All streams paused (not yet implemented).' : 'Resume streams (not yet implemented).');
        setPauseButtonLabels();
      });
    });

    exportAllButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (!currentStreamId) {
          appendMessage('agent', 'Select a stream to export data first.');
          return;
        }
        exportData(currentStreamId, 'csv');
      });
    });

    setPauseButtonLabels();

    chatForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const prompt = messageInput.value.trim();
      if (!prompt) return;

      appendMessage('user', escapeHtml(prompt));
      messageInput.value = '';

      const pending = appendMessage('agent', `Parsing “${escapeHtml(prompt)}”…`);
      try {
        const response = await fetch('/v1/streams/parse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: prompt }),
        });
        if (!response.ok) throw new Error(await response.text());
        const parsed = await response.json();
        renderParseSummary(parsed, pending);
      } catch (err) {
        pending.innerHTML = `
          <div>Error parsing request.</div>
          <div style="margin-top:8px;color:#fca5a5;font-size:13px;">${escapeHtml(err.message)}</div>
        `;
      }
    });

    function renderParseSummary(parsed, bubble) {
      const rows = parsed.spec.sources.filter(src => src.type === 'ccxt').map(src => `
        <tr>
          <td>${escapeHtml((src.exchange || 'BINANCEUS').toUpperCase())}</td>
          <td>${escapeHtml((src.symbols || []).join(', '))}</td>
          <td>${escapeHtml((src.fields || []).join(', ') || 'price, volume')}</td>
        </tr>
      `).join('');

      bubble.innerHTML = `
        <div>Here’s the stream I can create:</div>
        <table style="margin-top:12px;border-collapse:collapse;width:100%;font-size:12px;">
          <thead>
            <tr style="background:rgba(62,120,178,0.18);">
              <th style="padding:6px 8px;text-align:left;border:1px solid rgba(62,120,178,0.16);">Exchange</th>
              <th style="padding:6px 8px;text-align:left;border:1px solid rgba(62,120,178,0.16);">Symbols</th>
              <th style="padding:6px 8px;text-align:left;border:1px solid rgba(62,120,178,0.16);">Fields</th>
            </tr>
          </thead>
          <tbody>${rows || '<tr><td colspan="3" style="padding:8px;color:#f87171;">No CCXT source detected.</td></tr>'}</tbody>
        </table>
        <div style="margin-top:12px;display:flex;gap:10px;">
          <button id="confirmLaunchBtn" style="border:1px solid rgba(0,75,168,0.4);background:rgba(0,75,168,0.22);color:#e0ecff;padding:8px 12px;border-radius:12px;font-size:12px;cursor:pointer;">Launch</button>
          <button id="cancelLaunchBtn" style="border:1px solid rgba(148,163,184,0.3);background:rgba(148,163,184,0.12);color:#c3cfe4;padding:8px 12px;border-radius:12px;font-size:12px;cursor:pointer;">Modify</button>
        </div>
      `;

      bubble.querySelector('#confirmLaunchBtn').addEventListener('click', async () => {
        bubble.innerHTML = 'Launching stream…';
        try {
          const response = await fetch('/v1/streams', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ spec: parsed.spec }),
          });
          if (!response.ok) throw new Error(await response.text());
          const stream = await response.json();
          addSession(stream.stream_id, stream.ws_url, parsed.spec);
          bubble.innerHTML = `
            Stream <code>${escapeHtml(stream.stream_id)}</code> started.
            <div style="margin-top:10px;">
              <a href="#" data-open-stream="${stream.stream_id}" style="color:var(--accent);text-decoration:none;">Open stream workspace →</a>
            </div>
          `;
          const openLink = bubble.querySelector('[data-open-stream]');
          if (openLink) {
            openLink.addEventListener('click', (event) => {
              event.preventDefault();
              loadStream(stream.stream_id);
            });
          }
        } catch (err) {
          bubble.innerHTML = `Failed to launch: ${escapeHtml(err.message)}`;
        }
      });

      bubble.querySelector('#cancelLaunchBtn').addEventListener('click', () => {
        bubble.innerHTML = 'Okay — adjust your request and send again.';
      });
    }

    function addSession(streamId, wsUrl, spec) {
      activeStreams.set(streamId, {
        streamId,
        wsUrl,
        spec,
        metrics: null,
        schema: null,
        derivedSchema: null,
        status: 'LIVE',
        priceHistory: [],
        latencyHistory: [],
        lastEvent: null,
        socket: null,
        createdAt: spec?.created_at ? new Date(spec.created_at).getTime() : Date.now(),
      });
      renderSessions();
      const entry = activeStreams.get(streamId);
      if (entry) {
        openStreamSocket(entry);
      }
      pollStreamData(streamId);
    }

    function openStreamSocket(entry) {
      try {
        entry.status = 'CONNECTING';
        renderSessions();
        const url = entry.wsUrl.replace('localhost', window.location.hostname);
        const socket = new WebSocket(url);
        entry.socket = socket;

        socket.onopen = () => {
          entry.status = 'LIVE';
          renderSessions();
          if (currentStreamId === entry.streamId) renderStreamDetail(entry);
        };

        socket.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            entry.lastEvent = payload;
            const tsValue = payload.ts || payload.window_end;
            if (tsValue) {
              const ts = new Date(tsValue).getTime();
              entry.latencyHistory.push(Date.now() - ts);
              if (entry.latencyHistory.length > 50) entry.latencyHistory.shift();
            }

            const price = extractRepresentativePrice(payload);
            if (typeof price === 'number' && !Number.isNaN(price)) {
              entry.priceHistory.push(price);
              if (entry.priceHistory.length > 120) entry.priceHistory.shift();
            }
            if (!entry.schema) {
              entry.derivedSchema = deriveSchemaFromEvent(payload);
            }
            if (currentStreamId === entry.streamId) renderStreamDetail(entry);
            renderSessions();
          } catch (err) {
            console.warn('Malformed event', err);
          }
        };

        socket.onerror = () => {
          entry.status = 'ERROR';
          renderSessions();
        };

        socket.onclose = () => {
          entry.socket = null;
          if (entry.status === 'LIVE') {
            entry.status = 'DISCONNECTED';
          }
          renderSessions();
        };
      } catch (err) {
        console.warn('WebSocket failure', err);
        entry.status = 'ERROR';
        renderSessions();
      }
    }

    function renderSessions() {
      const fragments = [];
      for (const [streamId, stream] of activeStreams.entries()) {
        fragments.push(`
          <div class="session-item ${streamId === currentStreamId ? 'active' : ''}" data-stream="${streamId}">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong style="font-size:13px;color:#f7f9ff;">${escapeHtml((stream.spec.symbols || []).join(', ') || streamId.slice(0, 8))}</strong>
              <span>${escapeHtml(stream.status)}</span>
            </div>
            <span>ID: ${escapeHtml(streamId)}</span>
            <span>Interval: ${(stream.spec.interval_sec || 1)}s</span>
          </div>
        `);
      }
      sessionList.innerHTML = fragments.join('') || '<div class="session-empty">No streams launched yet.</div>';
      sessionList.querySelectorAll('[data-stream]').forEach(node => node.addEventListener('click', () => loadStream(node.dataset.stream)));
      renderStreamsDirectory();
    }

    function renderStreamsDirectory() {
      if (!streamsDirectory) return;
      const cards = [];
      for (const [streamId, stream] of activeStreams.entries()) {
        const title = (stream.spec.symbols || []).join(', ') || streamId.slice(0, 8);
        const interval = stream.spec.interval_sec || 1;
        let latencyValue = stream.metrics?.mean_latency_ms;
        const latencyHistory = stream.latencyHistory || [];
        if (latencyValue == null && latencyHistory.length) {
          const sum = latencyHistory.reduce((acc, val) => acc + val, 0);
          latencyValue = sum / latencyHistory.length;
        }
        const latency = latencyValue != null ? `${latencyValue.toFixed(1)} ms` : '—';
        const latestPrice = extractRepresentativePrice(stream.lastEvent);
        const priceText = typeof latestPrice === 'number'
          ? `$${latestPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
          : '—';
        const status = stream.status || 'LIVE';
        const statusClass = status.toUpperCase().includes('STOP')
          ? 'status-pill error'
          : status.toUpperCase().includes('PAUSE')
            ? 'status-pill warn'
            : 'status-pill';
        const eventsPerMinute = stream.metrics?.events_last_minute ?? '—';
        const isActive = streamId === currentStreamId;
        cards.push(`
          <article class="stream-card${isActive ? ' active' : ''}" data-stream="${streamId}">
            <header>
              <h3>${escapeHtml(title)}</h3>
              <span class="${statusClass}">${escapeHtml(status)}</span>
            </header>
            <div class="stream-meta">
              <span>Interval: ${interval}s</span>
              <span>Latency: ${latency}</span>
              <span>Events (60s): ${eventsPerMinute}</span>
              <span>Last price: ${escapeHtml(priceText)}</span>
            </div>
            <footer>
              <span>ID: ${escapeHtml(streamId)}</span>
              <button type="button">Open workspace</button>
            </footer>
          </article>
        `);
      }
      streamsDirectory.innerHTML = cards.join('') || '<div class="stream-empty">No streams launched yet. Use the chat to request one.</div>';
    }

    async function pollStreamData(streamId) {
      try {
        const [schemaRes, metricsRes] = await Promise.all([
          fetch(`/v1/streams/${streamId}/schema`),
          fetch(`/v1/streams/${streamId}/metrics`)
        ]);
        if (!schemaRes.ok) throw new Error(await schemaRes.text());
        if (!metricsRes.ok) throw new Error(await metricsRes.text());
        const schema = await schemaRes.json();
        const metrics = await metricsRes.json();
        const entry = activeStreams.get(streamId);
        if (entry) {
          if (schema && Object.keys(schema).length) {
            entry.schema = schema;
          }
          entry.metrics = metrics;
          entry.status = metrics.status || 'LIVE';
          if (metrics.created_at && !Number.isNaN(Date.parse(metrics.created_at))) {
            entry.createdAt = new Date(metrics.created_at).getTime();
          }
          if (metrics.latency_ms != null) {
            entry.latencyHistory.push(metrics.latency_ms);
            if (entry.latencyHistory.length > 20) entry.latencyHistory.shift();
          }
          if (currentStreamId === streamId) renderStreamDetail(entry);
          renderSessions();
        }
      } catch (err) {
        console.warn('Metrics fetch failed', err);
      } finally {
        setTimeout(() => pollStreamData(streamId), 10000);
      }
    }

    function loadStream(streamId) {
      const entry = activeStreams.get(streamId);
      if (!entry) return;
      currentStreamId = streamId;
      setView(VIEW_DETAIL);
      renderSessions();
      renderStreamDetail(entry);
    }

    function renderStreamDetail(stream) {
      const interval = stream.spec.interval_sec || 1;
      const createdSource = stream.metrics?.created_at || stream.spec.created_at;
      const created = createdSource ? new Date(createdSource) : null;
      let latencyValue = stream.metrics?.mean_latency_ms;
      if (latencyValue == null && stream.latencyHistory.length) {
        const sum = stream.latencyHistory.reduce((acc, val) => acc + val, 0);
        latencyValue = sum / stream.latencyHistory.length;
      }
      const latency = latencyValue != null ? `${latencyValue.toFixed(1)} ms` : '—';
      const latestPrice = extractRepresentativePrice(stream.lastEvent);
      const currentTick = stream.metrics?.current_tick || stream.lastEvent?.ts || stream.lastEvent?.window_end || '—';
      const eventsPerMinute = stream.metrics?.events_last_minute ?? '—';
      const dropped = stream.metrics?.dropped ?? '—';
      let uptime = stream.metrics?.uptime;
      if (!uptime && stream.createdAt) {
        const diffMs = Date.now() - stream.createdAt;
        uptime = formatDuration(diffMs);
      }
      uptime = uptime || '—';
      const subscribers = stream.metrics?.subscribers ?? '—';

      if (headerSummary) {
        headerSummary.innerHTML = `
          <h2>${escapeHtml((stream.spec.symbols || []).join(', ') || stream.streamId)}</h2>
          <div style="display:flex;gap:18px;font-size:13px;color:var(--text-muted);">
            <span>Stream ID: ${escapeHtml(stream.streamId)}</span>
            <span>Interval: ${interval}s</span>
            <span>Latency: ${latency}</span>
            <span>Created: ${created ? created.toISOString() : '—'}</span>
          </div>
        `;
      }

      streamStatus.style.display = 'inline-flex';
      streamStatus.textContent = stream.status;
      streamStatus.className = 'status-pill ' + (stream.status.toUpperCase().includes('STOP') ? 'error' : stream.status.toUpperCase().includes('PAUSE') ? 'warn' : '');

      const schemaToRender = getDisplaySchema(stream);

      detailBody.innerHTML = `
        <div class="panel">
          <h3>Stream Metadata</h3>
          <dl>
            <dt>Stream ID</dt><dd>${escapeHtml(stream.streamId)}</dd>
            <dt>Status</dt><dd>${escapeHtml(stream.status)}</dd>
            <dt>Interval</dt><dd>${interval}s</dd>
            <dt>Latency</dt><dd>${latency}</dd>
            <dt>Created</dt><dd>${created ? created.toISOString() : '—'}</dd>
            <dt>Symbols</dt><dd>${escapeHtml((stream.spec.symbols || []).join(', '))}</dd>
            <dt>Sources</dt><dd>${escapeHtml((stream.spec.sources || []).map(s => s.type).join(', '))}</dd>
            <dt>Exchanges</dt><dd>${escapeHtml((stream.spec.sources || []).flatMap(s => s.exchange ? [s.exchange.toUpperCase()] : []).join(', ') || 'BINANCEUS')}</dd>
            <dt>Driver Stream</dt><dd>CCXT</dd>
            <dt>Type</dt><dd>AggregatedEvent</dd>
            <dt>Last price</dt><dd>${latestPrice != null ? '$' + latestPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '—'}</dd>
          </dl>
        </div>
        <div class="panel">
          <h3>Data Schema</h3>
          <div style="max-height:220px;overflow:auto;font-family:var(--mono);font-size:12px;border:1px solid rgba(62,120,178,0.2);border-radius:12px;padding:12px;background:rgba(19,23,31,0.95);">
            ${Object.entries(schemaToRender || {}).map(([field, meta]) => {
              if (typeof meta === 'string') {
                return `<div>${escapeHtml(field)}: ${escapeHtml(meta)}</div>`;
              }
              const descriptor = meta?.type ? escapeHtml(meta.type) : 'unknown';
              const suffix = meta?.optional ? ' (optional)' : '';
              return `<div>${escapeHtml(field)}: ${descriptor}${suffix}</div>`;
            }).join('') || 'Schema unavailable'}
          </div>
          <div style="display:flex;gap:10px;">
            <button class="action-btn" onclick="copySchema('${stream.streamId}', 'json')">Copy Schema JSON</button>
            <button class="action-btn" onclick="copySchema('${stream.streamId}', 'csv')">Copy CSV Header</button>
          </div>
        </div>
        <div class="panel column-merge">
          <h3>Integration Snippets</h3>
          <div class="code-block">
            <button onclick="copySnippet('python-${stream.streamId}')">Copy</button>
            <pre><code id="python-${stream.streamId}"></code></pre>
          </div>
          <div class="code-block">
            <button onclick="copySnippet('ws-${stream.streamId}')">Copy</button>
            <pre><code id="ws-${stream.streamId}"></code></pre>
          </div>
          <div class="code-block">
            <button onclick="copySnippet('curl-${stream.streamId}')">Copy</button>
            <pre><code id="curl-${stream.streamId}"></code></pre>
          </div>
        </div>
        <div class="panel">
          <h3>Live Metrics</h3>
          <div class="metrics-grid">
            <div><span>Current tick</span>${escapeHtml(String(currentTick))}</div>
            <div><span>Events (60s)</span>${eventsPerMinute}</div>
            <div><span>Mean latency</span>${latency}</div>
            <div><span>Dropped packets</span>${dropped}</div>
            <div><span>Uptime</span>${uptime}</div>
            <div><span>Subscribers</span>${subscribers}</div>
          </div>
          <div class="sparkline-container" id="latencySpark-${stream.streamId}">
            <canvas></canvas>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="action-btn" onclick="refreshMetrics('${stream.streamId}')">Refresh</button>
            <button class="action-btn" onclick="exportData('${stream.streamId}', 'csv')">Export CSV (1h)</button>
            <button class="action-btn" onclick="exportData('${stream.streamId}', 'parquet')">Export Parquet</button>
          </div>
        </div>
        <div class="panel">
          <h3>Actions</h3>
          <div class="actions-list">
            <div class="action-btn" onclick="restartStream('${stream.streamId}')">Restart Stream</div>
            <div class="action-btn" onclick="duplicateStream('${stream.streamId}')">Duplicate Spec</div>
            <div class="action-btn" onclick="downloadSpec('${stream.streamId}')">Download Spec JSON</div>
            <div class="action-btn danger" onclick="stopStream('${stream.streamId}')">Stop Stream</div>
          </div>
        </div>
      `;

      const pythonSnippet = `from bond import listen\n\nasync def main():\n    async for event in listen("${stream.streamId}"):\n        print(event)`;
      const wsActual = stream.wsUrl.replace('localhost', window.location.hostname);
      const wsDisplay = wsActual.replace(/token=.*$/i, 'token=***');
      const curlSnippet = `curl -X GET "https://api.bond.dev/v1/streams/${stream.streamId}" \\\n     -H "Authorization: Bearer <token>"`;

      setSnippet(`python-${stream.streamId}`, 'python', pythonSnippet);
      setSnippet(`ws-${stream.streamId}`, 'url', wsActual, wsDisplay);
      setSnippet(`curl-${stream.streamId}`, 'shell', curlSnippet);

      requestAnimationFrame(() => renderLatencySparkline(stream));
    }

    function copySchema(streamId, type) {
      const entry = activeStreams.get(streamId);
      if (!entry) return;
      const schema = getDisplaySchema(entry);
      if (!schema || !Object.keys(schema).length) return;
      if (type === 'json') {
        navigator.clipboard.writeText(JSON.stringify(schema, null, 2));
      } else {
        navigator.clipboard.writeText(Object.keys(schema).join(','));
      }
    }

    function highlightSnippet(lang, code) {
      let escaped = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      const apply = (regex, cls) => {
        escaped = escaped.replace(regex, `<span class="${cls}">$1</span>`);
      };

      if (lang === 'python') {
        apply(/\b(async|await|for|in|from|import|print|return|def|class|with|as|yield|if|else|elif)\b/g, 'kw');
        apply(/\b(True|False|None)\b/g, 'const');
        apply(/(&quot;.*?&quot;)/g, 'str');
        apply(/(&#39;.*?&#39;)/g, 'str');
        apply(/(#.*?$)/gm, 'comment');
      } else if (lang === 'shell') {
        apply(/^(curl)/gm, 'cmd');
        apply(/\s(-{1,2}\w+)/g, 'flag');
        apply(/(https?:\/\/[^\s]+)/g, 'str');
        apply(/(".*?")/g, 'str');
      } else if (lang === 'url') {
        apply(/(wss?:\/\/[^\s]+)/g, 'str');
        apply(/(token=)([^\s]+)/g, 'flag');
      }

      escaped = escaped
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
        .replace(/  /g, '&nbsp;&nbsp;')
        .replace(/\n/g, '<br>');

      return escaped;
    }

    function setSnippet(elementId, lang, code, displayCode = null) {
      const node = document.getElementById(elementId);
      if (!node) return;
      node.dataset.snippet = code;
      const toRender = displayCode == null ? code : displayCode;
      node.innerHTML = highlightSnippet(lang, toRender);
    }

    function copySnippet(elementId) {
      const node = document.getElementById(elementId);
      if (!node) return;
      const text = node.dataset.snippet || node.innerText || '';
      navigator.clipboard.writeText(text);
    }

    function extractRepresentativePrice(event) {
      if (!event) return null;
      if (typeof event.price_close === 'number') return event.price_close;
      if (typeof event.price_avg === 'number') return event.price_avg;
      const exchangeData = event.raw_data?.exchange_data;
      if (exchangeData) {
        for (const exchange of Object.keys(exchangeData)) {
          const symbols = exchangeData[exchange]?.symbols || {};
          for (const symbol of Object.keys(symbols)) {
            const price = symbols[symbol]?.price;
            if (typeof price === 'number') return price;
          }
        }
      }
      return null;
    }

    function deriveSchemaFromEvent(event) {
      if (!event || typeof event !== 'object') return null;
      const result = {};
      for (const [key, value] of Object.entries(event)) {
        result[key] = inferType(value);
      }
      return result;
    }

    function inferType(value) {
      if (value === null || value === undefined) return { type: 'unknown', optional: true };
      if (typeof value === 'number') {
        return { type: Number.isInteger(value) ? 'int' : 'float' };
      }
      if (typeof value === 'string') return { type: 'string' };
      if (typeof value === 'boolean') return { type: 'bool' };
      if (Array.isArray(value)) return { type: 'array' };
      if (value instanceof Date) return { type: 'datetime' };
      if (typeof value === 'object') {
        return { type: 'object', optional: false };
      }
      return { type: typeof value };
    }

    function getDisplaySchema(stream) {
      const base = (stream.schema && Object.keys(stream.schema).length) ? stream.schema : (stream.derivedSchema || {});
      const entries = Object.entries(base || {});
      const filtered = {};
      const eventKeys = stream.lastEvent ? new Set(Object.keys(stream.lastEvent)) : null;

      for (const [field, meta] of entries) {
        if (eventKeys && !eventKeys.has(field)) continue;
        filtered[field] = meta;
      }

      if ((!filtered.symbol) && ((stream.spec?.symbols || []).length > 1 || stream.lastEvent?.symbol)) {
        filtered.symbol = { type: 'string' };
      }

      return filtered;
    }

    function formatDuration(milliseconds) {
      if (!Number.isFinite(milliseconds) || milliseconds < 0) return null;
      const totalSeconds = Math.floor(milliseconds / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      const parts = [];
      if (hours) parts.push(`${hours}h`);
      if (minutes) parts.push(`${minutes}m`);
      if (!parts.length || seconds) parts.push(`${seconds}s`);
      return parts.join(' ');
    }

    async function refreshMetrics(streamId) {
      const entry = activeStreams.get(streamId);
      if (!entry) return;
      try {
        const response = await fetch(`/v1/streams/${streamId}/metrics`);
        if (!response.ok) throw new Error(await response.text());
        entry.metrics = await response.json();
        renderStreamDetail(entry);
      } catch (err) {
        appendMessage('agent', `Unable to refresh metrics: ${escapeHtml(err.message)}`);
      }
    }

    async function exportData(streamId, format) {
      try {
        const response = await fetch(`/v1/streams/${streamId}/export?format=${format}`);
        if (!response.ok) throw new Error(await response.text());
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${streamId}.${format}`;
        link.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        appendMessage('agent', `Export failed: ${escapeHtml(err.message)}`);
      }
    }

    async function restartStream(streamId) {
      const entry = activeStreams.get(streamId);
      try {
        await fetch(`/v1/streams/${streamId}/restart`, { method: 'PATCH' });
        appendMessage('agent', `Stream ${escapeHtml(streamId)} restarted.`);
        if (entry?.socket) {
          entry.socket.close();
          entry.socket = null;
        }
        if (entry) {
          entry.status = 'CONNECTING';
          openStreamSocket(entry);
        }
        refreshMetrics(streamId);
      } catch (err) {
        appendMessage('agent', `Restart failed: ${escapeHtml(err.message)}`);
      }
    }

    async function duplicateStream(streamId) {
      const entry = activeStreams.get(streamId);
      if (!entry) return;
      try {
        const response = await fetch('/v1/streams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spec: entry.spec }),
        });
        if (!response.ok) throw new Error(await response.text());
        const stream = await response.json();
        appendMessage('agent', `Duplicated stream as <code>${escapeHtml(stream.stream_id)}</code>.`);
        addSession(stream.stream_id, stream.ws_url, entry.spec);
        loadStream(stream.stream_id);
      } catch (err) {
        appendMessage('agent', `Duplicate failed: ${escapeHtml(err.message)}`);
      }
    }

    async function downloadSpec(streamId) {
      try {
        const response = await fetch(`/v1/streams/${streamId}/spec`);
        if (!response.ok) throw new Error(await response.text());
        const spec = await response.json();
        const blob = new Blob([JSON.stringify(spec, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${streamId}_spec.json`;
        link.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        appendMessage('agent', `Spec download failed: ${escapeHtml(err.message)}`);
      }
    }

    async function stopStream(streamId) {
      const entry = activeStreams.get(streamId);
      if (!entry) return;
      try {
        await fetch(`/v1/streams/${streamId}`, { method: 'DELETE' });
        appendMessage('agent', `Stream ${escapeHtml(streamId)} stopped.`);
        if (entry.socket) {
          entry.socket.close();
          entry.socket = null;
        }
        const removedWasCurrent = streamId === currentStreamId;
        activeStreams.delete(streamId);
        if (removedWasCurrent) {
          currentStreamId = null;
          detailBody.innerHTML = '<div class="panel column-merge" style="text-align:center;opacity:0.6;"><h3>Stream stopped</h3><p style="font-size:13px;color:var(--text-muted);">Select another stream or launch a new one.</p></div>';
          streamStatus.style.display = 'none';
        }
        renderSessions();
        if (removedWasCurrent) {
          setView(activeStreams.size ? VIEW_STREAMS : VIEW_CHAT);
        }
      } catch (err) {
        appendMessage('agent', `Failed to stop stream: ${escapeHtml(err.message)}`);
      }
    }

    function renderLatencySparkline(stream) {
      const container = document.getElementById(`latencySpark-${stream.streamId}`);
      if (!container) return;
      const canvas = container.querySelector('canvas');
      const ctx = canvas.getContext('2d');
      const chartData = stream.latencyHistory.slice(-20);
      if (!chartData.length) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'var(--text-muted)';
        ctx.font = '11px var(--mono)';
        ctx.fillText('No latency samples yet', 10, 28);
        return;
      }
      const maxLatency = Math.max(...chartData);
      const minLatency = Math.min(...chartData);
      const span = maxLatency - minLatency || 1;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = 'rgba(0,75,168,0.6)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      chartData.forEach((value, idx) => {
        const x = (idx / (chartData.length - 1)) * canvas.width;
        const y = canvas.height - ((value - minLatency) / span) * (canvas.height - 4) - 2;
        if (idx === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    document.addEventListener('keydown', (event) => {
      if (event.metaKey && event.key.toLowerCase() === 'n') {
        event.preventDefault();
        messageInput.focus();
      }
      if (event.metaKey && event.key.toLowerCase() === 'k') {
        event.preventDefault();
        pauseAll = !pauseAll;
        appendMessage('agent', pauseAll ? 'All streams paused (not yet implemented).' : 'Resume streams (not yet implemented).');
        setPauseButtonLabels();
      }
    });

    renderSessions();
    setView(VIEW_CHAT);

    appendMessage('agent', `Bond Agent ready.
    <div style="margin-top:12px;font-size:12px;color:var(--text-muted);">
      Try: “Stream BTC/USDT every 5 seconds.”
      <br/>Move over to Streams whenever you want to inspect or tweak an active feed.
    </div>`);
  </script>
</body>
</html>

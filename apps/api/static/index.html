<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bond Terminal - Real-time Market Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-tertiary: #1a1f2e;
      --bg-card: #151b28;
      --border-color: #1f2937;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --accent-purple: #8b5cf6;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header / Navigation */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0 32px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .header-stats {
      display: flex;
      gap: 32px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      height: calc(100vh - 64px);
      overflow: hidden;
    }

    /* Left Panel - Configuration */
    .config-panel {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      padding: 24px;
    }

    .config-panel::-webkit-scrollbar {
      width: 8px;
    }

    .config-panel::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    .config-panel::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .panel-section {
      margin-bottom: 28px;
      padding-bottom: 28px;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-section:last-child {
      border-bottom: none;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: var(--accent-blue);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }

    /* Form Elements */
    select, input[type="number"], input[type="text"] {
      width: 100%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--accent-blue);
      background: var(--bg-card);
    }

    select option {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    /* Buttons */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-success {
      background: var(--accent-green);
      color: white;
      width: 100%;
      padding: 14px;
      font-size: 14px;
      margin-top: 8px;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }

    .btn-danger {
      background: transparent;
      color: var(--accent-red);
      border: 1px solid var(--accent-red);
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: var(--accent-red);
      color: white;
    }

    /* Exchange Cards */
    .exchange-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .exchange-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }

    .exchange-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .exchange-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Field Selection */
    .fields-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .field-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 8px 10px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .field-item:hover {
      background: var(--bg-secondary);
      border-color: var(--accent-blue);
    }

    .field-item input[type="checkbox"] {
      cursor: pointer;
      accent-color: var(--accent-blue);
    }

    .field-item label {
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Right Panel - Data Display */
    .data-panel {
      background: var(--bg-primary);
      overflow-y: auto;
      padding: 24px;
    }

    .data-panel::-webkit-scrollbar {
      width: 8px;
    }

    .data-panel::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    .data-panel::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    /* Performance Stats Bar */
    .perf-stats {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: none;
    }

    .perf-stats.active {
      display: block;
    }

    .perf-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
    }

    .perf-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .perf-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .perf-value {
      font-size: 24px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
    }

    .perf-value.green { color: var(--accent-green); }
    .perf-value.blue { color: var(--accent-blue); }
    .perf-value.gray { color: var(--text-muted); }

    /* Data Grid */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      display: none;
    }

    .data-grid.active {
      display: grid;
    }

    .data-tile {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .data-tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      opacity: 0;
      transition: opacity 0.2s;
    }

    .data-tile:hover {
      border-color: var(--accent-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .data-tile:hover::before {
      opacity: 1;
    }

    .tile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .tile-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .tile-source {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 3px 8px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
    }

    .tile-value {
      font-size: 32px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .tile-value.waiting {
      font-size: 14px;
      color: var(--text-muted);
      font-style: italic;
      font-family: 'Inter', sans-serif;
    }

    .tile-change {
      font-size: 12px;
      margin-top: 8px;
      font-family: 'JetBrains Mono', monospace;
    }

    .tile-change.positive { color: var(--accent-green); }
    .tile-change.negative { color: var(--accent-red); }

    /* Console Output */
    .console {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      color: var(--accent-green);
    }

    .console.active {
      display: block;
    }

    .console::-webkit-scrollbar {
      width: 6px;
    }

    .console::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    .console::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 14px;
      line-height: 1.6;
    }

    /* Utility */
    .hidden { display: none; }

    .hint-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      line-height: 1.5;
    }

    /* Input hints */
    .input-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      .config-panel {
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        height: auto;
        max-height: 60vh;
      }
      .perf-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo">
      <span>‚ö°</span>
      <span>BOND TERMINAL</span>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-label">Active Streams</div>
        <div class="stat-value" id="headerStreamCount">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Status</div>
        <div class="stat-value" id="headerStatus">Ready</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Latency</div>
        <div class="stat-value" id="headerLatency">--ms</div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Panel: Configuration -->
    <div class="config-panel">
      <!-- Natural Language Input -->
      <div class="panel-section">
        <div class="section-header">
          <div class="section-number">üí¨</div>
          <span>Natural Language Query</span>
        </div>
        <textarea
          id="nlQuery"
          placeholder="Example: show me live bitcoin prices from kraken with volume"
          style="width: 100%; min-height: 80px; resize: vertical; font-family: 'Inter', sans-serif; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.5;"
        ></textarea>
        <div class="hint-text">
          üí° Try: "btc prices right now" | "eth from all exchanges" | "solana with twitter sentiment"
        </div>
        <button type="button" class="btn btn-success" onclick="submitNaturalLanguage()" style="margin-top: 12px;">
          ü§ñ Parse & Launch Stream
        </button>
        <div style="text-align: center; margin: 16px 0; color: var(--text-muted); font-size: 12px; font-weight: 600;">
          ‚Äî OR ‚Äî
        </div>
      </div>

      <form id="streamForm">
        <!-- Symbol Selection -->
        <div class="panel-section">
          <div class="section-header">
            <div class="section-number">1</div>
            <span>Market Symbol</span>
          </div>
          <select id="symbol" required>
            <option value="BTC">Bitcoin (BTC)</option>
            <option value="ETH">Ethereum (ETH)</option>
            <option value="SOL">Solana (SOL)</option>
            <option value="AVAX">Avalanche (AVAX)</option>
            <option value="MATIC">Polygon (MATIC)</option>
            <option value="LINK">Chainlink (LINK)</option>
            <option value="UNI">Uniswap (UNI)</option>
            <option value="DOGE">Dogecoin (DOGE)</option>
            <option value="ADA">Cardano (ADA)</option>
            <option value="DOT">Polkadot (DOT)</option>
          </select>
        </div>

        <!-- Exchange Selection -->
        <div class="panel-section">
          <div class="section-header">
            <div class="section-number">2</div>
            <span>Exchange Sources</span>
          </div>
          <div class="exchange-buttons">
            <button type="button" class="btn btn-secondary" onclick="addExchange('kraken')">+ Kraken</button>
            <button type="button" class="btn btn-secondary" onclick="addExchange('kucoin')">+ KuCoin</button>
          </div>
          <div id="exchangesContainer"></div>
        </div>

        <!-- Additional Data Sources -->
        <div class="panel-section">
          <div class="section-header">
            <div class="section-number">3</div>
            <span>Additional Sources</span>
          </div>
          <div class="fields-grid">
            <div class="field-item" onclick="toggleCheckbox('source_twitter')">
              <input type="checkbox" id="source_twitter">
              <label>Twitter/X</label>
            </div>
            <div class="field-item" onclick="toggleCheckbox('source_onchain')">
              <input type="checkbox" id="source_onchain">
              <label>On-Chain</label>
            </div>
            <div class="field-item" onclick="toggleCheckbox('source_liq')">
              <input type="checkbox" id="source_liq">
              <label>Liquidations</label>
            </div>
            <div class="field-item" onclick="toggleCheckbox('source_google_trends')">
              <input type="checkbox" id="source_google_trends">
              <label>Search Trends</label>
            </div>
          </div>
        </div>

        <!-- Google Trends Config -->
        <div class="panel-section hidden" id="googleTrendsConfig">
          <div class="section-header">
            <span>üîç Search Trends Configuration</span>
          </div>
          <div style="margin-bottom: 16px;">
            <label for="trends_keywords" style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px; font-weight: 500;">
              Keywords (comma-separated, max 5)
            </label>
            <input
              type="text"
              id="trends_keywords"
              placeholder="bitcoin, ethereum, crypto"
            >
            <div class="input-hint">üí° Leave blank to use selected symbol</div>
          </div>
          <div>
            <label for="trends_timeframe" style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px; font-weight: 500;">
              Timeframe
            </label>
            <select id="trends_timeframe">
              <option value="now 1-H">Last Hour</option>
              <option value="now 4-H">Last 4 Hours</option>
              <option value="now 1-d" selected>Last 24 Hours</option>
              <option value="now 7-d">Last 7 Days</option>
              <option value="today 1-m">Last 30 Days</option>
            </select>
          </div>
        </div>

        <!-- Update Interval -->
        <div class="panel-section">
          <div class="section-header">
            <div class="section-number">4</div>
            <span>Update Interval</span>
          </div>
          <label for="interval" style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px; font-weight: 500;">
            Seconds between updates
          </label>
          <input
            type="number"
            id="interval"
            min="0.1"
            step="0.1"
            value="1"
            required
            placeholder="1.0"
          >
          <div class="input-hint">‚ö° 0.1-0.5s = real-time | 1-3s = balanced | 5s+ = low frequency</div>
        </div>

        <button type="submit" class="btn btn-success">‚ö° Initialize Stream</button>
      </form>
    </div>

    <!-- Right Panel: Data Display -->
    <div class="data-panel">
      <div class="console" id="console"></div>

      <div class="perf-stats" id="perfStats">
        <div class="perf-grid">
          <div class="perf-item">
            <div class="perf-label">Update Speed</div>
            <div class="perf-value green" id="updateSpeed">--</div>
          </div>
          <div class="perf-item">
            <div class="perf-label">Total Updates</div>
            <div class="perf-value blue" id="updateCount">0</div>
          </div>
          <div class="perf-item">
            <div class="perf-label">Configured Interval</div>
            <div class="perf-value gray" id="configInterval">--s</div>
          </div>
          <div class="perf-item">
            <div class="perf-label">Stream Status</div>
            <div class="perf-value" id="updateStatus" style="font-size: 16px;">Standby</div>
          </div>
        </div>
      </div>

      <div class="data-grid" id="dataGrid"></div>

      <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-title">No Active Stream</div>
        <div class="empty-state-text">
          Configure your data sources in the left panel and initialize a stream to begin receiving real-time market intelligence.
        </div>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    const exchanges = new Map();
    const currentConfig = [];
    const availableFields = [
      { id: 'price', label: 'Last Price' },
      { id: 'bid', label: 'Bid' },
      { id: 'ask', label: 'Ask' },
      { id: 'high', label: '24h High' },
      { id: 'low', label: '24h Low' },
      { id: 'open', label: 'Open' },
      { id: 'close', label: 'Close' },
      { id: 'volume', label: 'Volume' }
    ];

    function sanitizeIdPart(value) {
      return (value || 'default').replace(/[^a-zA-Z0-9]/g, '_');
    }

    function toggleCheckbox(id) {
      const cb = document.getElementById(id);
      cb.checked = !cb.checked;

      if (id === 'source_google_trends') {
        const config = document.getElementById('googleTrendsConfig');
        if (cb.checked) {
          config.classList.remove('hidden');
        } else {
          config.classList.add('hidden');
        }
      }
    }

    function addExchange(exchangeName) {
      if (exchanges.has(exchangeName)) {
        alert(`${exchangeName} already added`);
        return;
      }

      const container = document.getElementById('exchangesContainer');
      const exchangeCard = document.createElement('div');
      exchangeCard.className = 'exchange-card';
      exchangeCard.id = `exchange_${exchangeName}`;

      let fieldsHTML = availableFields.map(field => `
        <div class="field-item" onclick="toggleCheckbox('${exchangeName}_${field.id}')">
          <input type="checkbox" id="${exchangeName}_${field.id}" data-exchange="${exchangeName}" data-field="${field.id}">
          <label for="${exchangeName}_${field.id}">${field.label}</label>
        </div>
      `).join('');

      exchangeCard.innerHTML = `
        <div class="exchange-header">
          <div class="exchange-name">${exchangeName}</div>
          <button type="button" class="btn btn-danger" onclick="removeExchange('${exchangeName}')">Remove</button>
        </div>
        <div class="fields-grid">
          ${fieldsHTML}
        </div>
      `;

      container.appendChild(exchangeCard);
      exchanges.set(exchangeName, new Set());
    }

    function removeExchange(exchangeName) {
      const exchangeCard = document.getElementById(`exchange_${exchangeName}`);
      if (exchangeCard) {
        exchangeCard.remove();
        exchanges.delete(exchangeName);
      }
    }

    document.getElementById('streamForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const symbol = document.getElementById('symbol').value;
      const interval = document.getElementById('interval').value;

      const exchangeConfigs = [];
      exchanges.forEach((fields, exchangeName) => {
        const selectedFields = [];
        availableFields.forEach(field => {
          const checkbox = document.getElementById(`${exchangeName}_${field.id}`);
          if (checkbox && checkbox.checked) {
            selectedFields.push(field.id);
          }
        });

        if (selectedFields.length > 0) {
          exchangeConfigs.push({
            exchange: exchangeName,
            fields: selectedFields,
            symbols: [`${symbol.toUpperCase()}/USDT`]
          });
        }
      });

      if (exchangeConfigs.length === 0) {
        alert('Please add at least one exchange and select fields');
        return;
      }

      currentConfig.length = 0;
      currentConfig.push(...exchangeConfigs);

      const spec = {
        sources: exchangeConfigs.map(config => ({
          type: 'ccxt',
          exchange: config.exchange,
          fields: config.fields,
          symbols: [`${symbol}/USDT`]
        })),
        interval_sec: parseFloat(interval),
        symbols: [`${symbol}/USDT`]
      };

      if (document.getElementById('source_twitter').checked) {
        spec.sources.push({ type: 'twitter', symbols: [`${symbol}/USDT`] });
      }
      if (document.getElementById('source_onchain').checked) {
        spec.sources.push({ type: 'onchain', chain: 'sol', event_types: ['tx', 'transfer'] });
      }
      if (document.getElementById('source_liq').checked) {
        spec.sources.push({ type: 'custom', mode: 'mock_liq' });
      }
      if (document.getElementById('source_google_trends').checked) {
        const keywordsInput = document.getElementById('trends_keywords').value;
        const timeframe = document.getElementById('trends_timeframe').value;
        const keywords = keywordsInput.trim()
          ? keywordsInput.split(',').map(k => k.trim().toLowerCase())
          : [symbol.toLowerCase()];

        spec.sources.push({
          type: 'google_trends',
          keywords: keywords,
          timeframe: timeframe
        });
      }

      const console_elem = document.getElementById('console');
      console_elem.classList.add('active');
      console_elem.innerHTML = '> Initializing stream...\n';

      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('headerStatus').textContent = 'Connecting';

      try {
        const response = await fetch('/v1/streams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spec })
        });

        const data = await response.json();

        if (!response.ok || !data.stream_id) {
          console_elem.innerHTML += `> ERROR: ${data.detail || JSON.stringify(data)}\n`;
          document.getElementById('headerStatus').textContent = 'Error';
          return;
        }

        console_elem.innerHTML += `> Stream ID: ${data.stream_id}\n`;
        console_elem.innerHTML += `> Establishing WebSocket connection...\n`;

        document.getElementById('headerStreamCount').textContent = '1';

        initializeDisplay(exchangeConfigs);

        if (ws) ws.close();

        const wsUrl = data.ws_url.replace('localhost', window.location.hostname);
        ws = new WebSocket(wsUrl);

        let lastUpdateTime = null;
        let updateCount = 0;

        ws.onopen = () => {
          console_elem.innerHTML += '> Connected - Streaming live data\n';
          document.getElementById('perfStats').classList.add('active');
          document.getElementById('dataGrid').classList.add('active');
          document.getElementById('configInterval').textContent = interval + 's';
          document.getElementById('updateStatus').textContent = 'üü¢ Active';
          document.getElementById('updateStatus').style.color = 'var(--accent-green)';
          document.getElementById('headerStatus').textContent = 'Active';
          document.getElementById('headerStatus').style.color = 'var(--accent-green)';
          lastUpdateTime = Date.now();
        };

        ws.onmessage = (event) => {
          const streamEvent = JSON.parse(event.data);

          const now = Date.now();
          const timeSinceLastUpdate = lastUpdateTime ? (now - lastUpdateTime) / 1000 : 0;
          lastUpdateTime = now;
          updateCount++;

          document.getElementById('updateSpeed').textContent = timeSinceLastUpdate.toFixed(3) + 's';
          document.getElementById('updateCount').textContent = updateCount;
          document.getElementById('headerLatency').textContent = (timeSinceLastUpdate * 1000).toFixed(0) + 'ms';

          const speedEl = document.getElementById('updateSpeed');
          if (timeSinceLastUpdate < 0.5) {
            speedEl.className = 'perf-value green';
          } else if (timeSinceLastUpdate < 2) {
            speedEl.className = 'perf-value blue';
          } else {
            speedEl.className = 'perf-value gray';
          }

          updateDataDisplay(streamEvent);
        };

        ws.onerror = () => {
          console_elem.innerHTML += '> WebSocket error\n';
          document.getElementById('headerStatus').textContent = 'Error';
          document.getElementById('headerStatus').style.color = 'var(--accent-red)';
        };

        ws.onclose = () => {
          console_elem.innerHTML += '> Connection closed\n';
          document.getElementById('headerStatus').textContent = 'Disconnected';
          document.getElementById('headerStatus').style.color = 'var(--text-muted)';
        };

      } catch (error) {
        console_elem.innerHTML += `> EXCEPTION: ${error.message}\n`;
        document.getElementById('headerStatus').textContent = 'Error';
      }
    });

    function initializeDisplay(exchangeConfigs) {
      const dataGrid = document.getElementById('dataGrid');
      let html = '';

      exchangeConfigs.forEach(config => {
        const symbols = (config.symbols && config.symbols.length > 0) ? config.symbols : [null];
        symbols.forEach(symbol => {
          config.fields.forEach(field => {
            const fieldLabel = availableFields.find(f => f.id === field)?.label || field;
            const symbolLabel = symbol ? symbol.toUpperCase() : '';
            const tileId = symbol
              ? `tile_${config.exchange}_${sanitizeIdPart(symbol)}_${field}`
              : `tile_${config.exchange}_${field}`;
            const sourceLabel = symbol
              ? `${config.exchange.toUpperCase()} ¬∑ ${symbolLabel}`
              : config.exchange.toUpperCase();
            html += `
              <div class="data-tile" id="${tileId}">
                <div class="tile-header">
                  <div class="tile-label">${fieldLabel}</div>
                  <div class="tile-source">${sourceLabel}</div>
                </div>
                <div class="tile-value waiting">Waiting for data...</div>
              </div>
            `;
          });
        });
      });

      if (document.getElementById('source_twitter').checked) {
        html += `
          <div class="data-tile" id="tile_tweets">
            <div class="tile-header">
              <div class="tile-label">Tweet Count</div>
              <div class="tile-source">TWITTER</div>
            </div>
            <div class="tile-value waiting">0</div>
          </div>
        `;
      }

      if (document.getElementById('source_onchain').checked) {
        html += `
          <div class="data-tile" id="tile_onchain">
            <div class="tile-header">
              <div class="tile-label">On-Chain Events</div>
              <div class="tile-source">BLOCKCHAIN</div>
            </div>
            <div class="tile-value waiting">0</div>
          </div>
        `;
      }

      if (document.getElementById('source_google_trends').checked) {
        const keywordsInput = document.getElementById('trends_keywords').value;
        const keywords = keywordsInput.trim()
          ? keywordsInput.split(',').map(k => k.trim())
          : [document.getElementById('symbol').value.toLowerCase()];

        keywords.forEach(keyword => {
          html += `
            <div class="data-tile" id="tile_trends_${keyword.replace(/\s+/g, '_')}">
              <div class="tile-header">
                <div class="tile-label">${keyword.toUpperCase()} Search Interest</div>
                <div class="tile-source">GOOGLE</div>
              </div>
              <div class="tile-value waiting">--/100</div>
            </div>
          `;
        });
      }

      dataGrid.innerHTML = html;
    }

    async function submitNaturalLanguage() {
      const query = document.getElementById('nlQuery').value.trim();
      if (!query) {
        alert('Please enter a query');
        return;
      }

      const console_elem = document.getElementById('console');
      console_elem.classList.add('active');
      console_elem.innerHTML = `> Parsing query: "${query}"\n`;
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('headerStatus').textContent = 'Parsing';

      try {
        // Parse natural language to spec
        const parseResponse = await fetch('/v1/streams/parse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        const parseData = await parseResponse.json();

        if (!parseResponse.ok) {
          console_elem.innerHTML += `> PARSE ERROR: ${parseData.detail || JSON.stringify(parseData)}\n`;
          document.getElementById('headerStatus').textContent = 'Error';
          return;
        }

        console_elem.innerHTML += `> LLM Reasoning: ${parseData.reasoning}\n`;
        console_elem.innerHTML += `> Creating stream...\n`;

        // Extract exchange configs from parsed data for display initialization
        const parsedSymbols = (parseData.parsed_config.symbols || []).map(sym => `${sym.toUpperCase()}/USDT`);
        const exchangeConfigs = (parseData.parsed_config.exchanges || []).map(cfg => ({
          ...cfg,
          symbols: parsedSymbols.length ? parsedSymbols : [`${document.getElementById('symbol').value.toUpperCase()}/USDT`]
        }));
        currentConfig.length = 0;
        currentConfig.push(...exchangeConfigs);

        // Create stream with parsed spec
        const response = await fetch('/v1/streams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spec: parseData.spec })
        });

        const data = await response.json();

        if (!response.ok || !data.stream_id) {
          console_elem.innerHTML += `> ERROR: ${data.detail || JSON.stringify(data)}\n`;
          document.getElementById('headerStatus').textContent = 'Error';
          return;
        }

        console_elem.innerHTML += `> Stream ID: ${data.stream_id}\n`;
        console_elem.innerHTML += `> Establishing WebSocket connection...\n`;

        document.getElementById('headerStreamCount').textContent = '1';

        initializeDisplay(exchangeConfigs);

        if (ws) ws.close();

        const wsUrl = data.ws_url.replace('localhost', window.location.hostname);
        ws = new WebSocket(wsUrl);

        let lastUpdateTime = null;
        let updateCount = 0;

        ws.onopen = () => {
          console_elem.innerHTML += '> Connected - Streaming live data\n';
          document.getElementById('perfStats').classList.add('active');
          document.getElementById('dataGrid').classList.add('active');
          document.getElementById('configInterval').textContent = parseData.spec.interval_sec + 's';
          document.getElementById('updateStatus').textContent = 'üü¢ Active';
          document.getElementById('updateStatus').style.color = 'var(--accent-green)';
          document.getElementById('headerStatus').textContent = 'Active';
          document.getElementById('headerStatus').style.color = 'var(--accent-green)';
          lastUpdateTime = Date.now();

          // Initialize tweet tile if Nitter source exists
          const hasNitterSource = parseData.spec.sources && parseData.spec.sources.some(s => s.type === 'nitter');
          if (hasNitterSource) {
            const dataGrid = document.getElementById('dataGrid');
            const nitterSource = parseData.spec.sources.find(s => s.type === 'nitter');
            const username = nitterSource.username || 'user';

            const tileHtml = `
              <div class="data-tile" id="tile_nitter_tweet" style="grid-column: 1 / -1;">
                <div class="tile-header">
                  <div class="tile-label">Latest Tweet from @${username}</div>
                  <div class="tile-source">TWITTER/X</div>
                </div>
                <div class="tile-value waiting" style="font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; min-height: 60px;">Waiting for tweet data...</div>
                <div class="tweet-timestamp" style="font-size: 12px; color: var(--text-muted); margin-top: 8px;"></div>
                <div class="tweet-stats" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></div>
              </div>
            `;
            dataGrid.innerHTML = tileHtml;
          }
        };

        ws.onmessage = (event) => {
          const streamEvent = JSON.parse(event.data);

          const now = Date.now();
          const timeSinceLastUpdate = lastUpdateTime ? (now - lastUpdateTime) / 1000 : 0;
          lastUpdateTime = now;
          updateCount++;

          document.getElementById('updateSpeed').textContent = timeSinceLastUpdate.toFixed(3) + 's';
          document.getElementById('updateCount').textContent = updateCount;
          document.getElementById('headerLatency').textContent = (timeSinceLastUpdate * 1000).toFixed(0) + 'ms';

          const speedEl = document.getElementById('updateSpeed');
          if (timeSinceLastUpdate < 0.5) {
            speedEl.className = 'perf-value green';
          } else if (timeSinceLastUpdate < 2) {
            speedEl.className = 'perf-value blue';
          } else {
            speedEl.className = 'perf-value gray';
          }

          updateDataDisplay(streamEvent);
        };

        ws.onerror = () => {
          console_elem.innerHTML += '> WebSocket error\n';
          document.getElementById('headerStatus').textContent = 'Error';
          document.getElementById('headerStatus').style.color = 'var(--accent-red)';
        };

        ws.onclose = () => {
          console_elem.innerHTML += '> Connection closed\n';
          document.getElementById('headerStatus').textContent = 'Disconnected';
          document.getElementById('headerStatus').style.color = 'var(--text-muted)';
        };

      } catch (error) {
        console_elem.innerHTML += `> EXCEPTION: ${error.message}\n`;
        document.getElementById('headerStatus').textContent = 'Error';
      }
    }

    function updateDataDisplay(event) {
      if (event.raw_data && event.raw_data.exchange_data) {
        currentConfig.forEach(config => {
          const exchangeData = event.raw_data.exchange_data[config.exchange];
          if (!exchangeData) {
            return;
          }
          const symbolEntries = exchangeData.symbols || {};
          const symbols = (config.symbols && config.symbols.length > 0) ? config.symbols : [null];

          symbols.forEach(symbol => {
            config.fields.forEach(field => {
              const tileId = symbol
                ? `tile_${config.exchange}_${sanitizeIdPart(symbol)}_${field}`
                : `tile_${config.exchange}_${field}`;
              const tile = document.getElementById(tileId);
              if (!tile) {
                return;
              }

              let value;
              if (symbol) {
                const possibleKeys = [
                  symbol,
                  symbol.toUpperCase(),
                  symbol.replace('/USDT', ''),
                  symbol.split('/')[0]
                ];
                for (const key of possibleKeys) {
                  if (key && symbolEntries[key]) {
                    value = symbolEntries[key][field];
                    if (value !== undefined) {
                      break;
                    }
                  }
                }
              } else {
                value = exchangeData[field];
              }

              if (value !== undefined && value !== null) {
                const valueDiv = tile.querySelector('.tile-value');
                valueDiv.classList.remove('waiting');
                if (typeof value === 'number') {
                  const isVolume = field === 'volume';
                  const formatted = value.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  });
                  valueDiv.textContent = isVolume ? formatted : '$' + formatted;
                } else {
                  valueDiv.textContent = value;
                }
              }
            });
          });
        });
      }

      const tweetsTile = document.getElementById('tile_tweets');
      if (tweetsTile && event.tweets !== undefined) {
        const valueDiv = tweetsTile.querySelector('.tile-value');
        valueDiv.classList.remove('waiting');
        valueDiv.textContent = event.tweets;
      }

      const onchainTile = document.getElementById('tile_onchain');
      if (onchainTile && event.onchain_count !== undefined) {
        const valueDiv = onchainTile.querySelector('.tile-value');
        valueDiv.classList.remove('waiting');
        valueDiv.textContent = event.onchain_count;
      }

      // Handle Nitter tweet data (from raw_data.tweet_data or direct event)
      const tweetData = event.raw_data?.tweet_data || (event.event_type === 'tweet' ? event : null);
      if (tweetData && tweetData.text) {
        let nitterTile = document.getElementById('tile_nitter_tweet');

        if (nitterTile) {
          // Update tweet text
          const valueDiv = nitterTile.querySelector('.tile-value');
          valueDiv.classList.remove('waiting');
          valueDiv.textContent = tweetData.text;

          // Update username in label
          const labelDiv = nitterTile.querySelector('.tile-label');
          if (labelDiv && tweetData.symbol) {
            labelDiv.textContent = `Latest Tweet from @${tweetData.symbol.toLowerCase()}`;
          }

          // Update timestamp
          const timestampDiv = nitterTile.querySelector('.tweet-timestamp');
          if (timestampDiv && tweetData.timestamp_posted) {
            timestampDiv.textContent = `Posted: ${tweetData.timestamp_posted}`;
          }

          // Update stats
          const statsDiv = nitterTile.querySelector('.tweet-stats');
          if (statsDiv && tweetData.stats) {
            statsDiv.textContent = `üí¨ ${tweetData.stats.replies || 0} | üîÅ ${tweetData.stats.retweets || 0} | ‚ù§Ô∏è ${tweetData.stats.likes || 0}`;
          }
        }
      }

      if (event.raw_data && event.raw_data.custom_data) {
        const customData = event.raw_data.custom_data;
        if (customData.source === 'google_trends' && customData.keyword) {
          const keyword = customData.keyword;
          const tileId = `tile_trends_${keyword.replace(/\s+/g, '_')}`;
          const tile = document.getElementById(tileId);

          if (tile && customData.interest !== undefined) {
            const valueDiv = tile.querySelector('.tile-value');
            valueDiv.classList.remove('waiting');
            valueDiv.textContent = `${customData.interest}/100`;

            if (customData.interest >= 75) {
              valueDiv.style.color = 'var(--accent-green)';
            } else if (customData.interest >= 50) {
              valueDiv.style.color = 'var(--accent-blue)';
            } else {
              valueDiv.style.color = 'var(--text-muted)';
            }
          }
        }
      }
    }
  </script>
</body>
</html>
